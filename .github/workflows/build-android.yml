name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9'
          channel: 'stable'

      # 4. –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è Android
      - name: Accept Android licenses
        run: |
          yes | sdkmanager --licenses || true

      # 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Get packages
        run: flutter pub get

      # 6. –°–æ–±–∏—Ä–∞–µ–º APK
      - name: Build APK
        run: |
          echo "=== –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ ==="
          flutter clean
          flutter build apk --release --no-tree-shake-icons
          echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω!"

      # 7. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º APK —Å –≤–µ—Ä—Å–∏–µ–π
      - name: Rename APK with version
        run: |
          VERSION=$(grep "version:" pubspec.yaml | sed "s/version: //" | tr -d ' ' | tr '+' '-')
          cp build/app/outputs/flutter-apk/app-release.apk "tension-app-v${VERSION}.apk"
          echo "üì± –§–∞–π–ª: tension-app-v${VERSION}.apk"

      # 8. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: tension-ceiling-app-NEW
          path: tension-app-*.apk
          retention-days: 1  # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ 1 –¥–µ–Ω—å
