name: Build and Release Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Позволяет запускать сборку вручную из вкладки Actions

env:
  # Основная версия приложения. При каждой сборке номер сборки (run_number) добавится автоматически.
  APP_VERSION_NAME: "1.0.0"

jobs:
  build:
    runs-on: ubuntu-latest # Используем последний стабильный образ Ubuntu

    steps:
      # Шаг 1: Получение кода из репозитория
      - name: Checkout repository
        uses: actions/checkout@v4

      # Шаг 2: Установка Java (требуется для Android SDK)
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      # Шаг 3: Установка Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9' # Рекомендуется указывать конкретную стабильную версию
          channel: 'stable'

      # Шаг 4: Разрешение лицензий Android SDK
      - name: Accept Android licenses
        run: |
          yes | sdkmanager --licenses || true
          flutter doctor --android-licenses

      # Шаг 5: Проверка окружения Flutter
      - name: Flutter doctor
        run: flutter doctor -v

      # Шаг 6: Установка зависимостей проекта
      - name: Install dependencies
        run: flutter pub get

      # Шаг 7: Сборка релизного APK
      - name: Build release APK
        run: |
          flutter build apk --release --no-tree-shake-icons
          echo "APK собран: $(pwd)/build/app/outputs/flutter-apk/app-release.apk"

      # Шаг 8: Загрузка собранного APK как артефакта
      # ИСПРАВЛЕНИЕ ОШИБКИ: используем v4 вместо deprecated v3
      - name: Upload APK as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          # Уникальное имя артефакта с номером сборки (требование v4).
          name: PotolokForLife-v${{ env.APP_VERSION_NAME }}-build-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          # Артефакт будет доступен 14 дней. Можно скачать со вкладки Actions.
          retention-days: 14

      # (ОПЦИОНАЛЬНО) Шаг 9: Создание GitHub Release и прикрепление APK
      # Работает только при триггере workflow_dispatch (ручной запуск) или по тегу.
      # Требует дополнительной настройки ключей подписи (см. инструкцию ниже).
      - name: Create GitHub Release & Upload APK
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-v${{ env.APP_VERSION_NAME }}+${{ github.run_number }}
          name: "Релиз v${{ env.APP_VERSION_NAME }} (Сборка #${{ github.run_number }})"
          body: |
            Автоматическая сборка APK.
            Номер запуска: #${{ github.run_number }}
            Собрано: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
          files: build/app/outputs/flutter-apk/app-release.apk
